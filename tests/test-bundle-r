#!/bin/sh

hg init test
cd test
cat >>afile <<EOF
0
EOF
hg add afile
hg commit -m "0.0" -d "1000000 0"
cat >>afile <<EOF
1
EOF
hg commit -m "0.1" -d "1000000 0"
cat >>afile <<EOF
2
EOF
hg commit -m "0.2" -d "1000000 0"
cat >>afile <<EOF
3
EOF
hg commit -m "0.3" -d "1000000 0"
hg update -C 0
cat >>afile <<EOF
1
EOF
hg commit -m "1.1" -d "1000000 0"
cat >>afile <<EOF
2
EOF
hg commit -m "1.2" -d "1000000 0"
cat >fred <<EOF
a line
EOF
cat >>afile <<EOF
3
EOF
hg add fred
hg commit -m "1.3" -d "1000000 0"
hg mv afile adifferentfile
hg commit -m "1.3m" -d "1000000 0"
hg update -C 3
hg mv afile anotherfile
hg commit -m "0.3m" -d "1000000 0"
hg debugindex .hg/data/afile.i
hg debugindex .hg/data/adifferentfile.i
hg debugindex .hg/data/anotherfile.i
hg debugindex .hg/data/fred.i
hg debugindex .hg/00manifest.i
hg verify
cd ..
for i in 0 1 2 3 4 5 6 7 8; do
   mkdir test-"$i"
   hg --cwd test-"$i" init
   hg -R test bundle -r "$i" test-"$i".hg test-"$i"
   cd test-"$i"
   hg unbundle ../test-"$i".hg
   hg verify
   hg tip -q
   cd ..
done
cd test-8
hg pull ../test-7
hg verify
hg rollback
cd ..

echo % should fail
hg -R test bundle --base 2 -r tip test-bundle-branch1.hg test-3
hg -R test bundle -r tip test-bundle-branch1.hg

hg -R test bundle --base 2 -r tip test-bundle-branch1.hg
hg -R test bundle --base 2 -r 7 test-bundle-branch2.hg
hg -R test bundle --base 2 test-bundle-all.hg
hg -R test bundle --base 3 -r tip test-bundle-should-fail.hg
cd test-2
echo % 2
hg tip -q
hg unbundle ../test-bundle-should-fail.hg
echo % 2
hg tip -q
hg unbundle ../test-bundle-all.hg
echo % 8
hg tip -q
hg rollback
echo % 2
hg tip -q
hg unbundle ../test-bundle-branch1.hg
echo % 4
hg tip -q
hg unbundle ../test-bundle-branch2.hg
echo % 8
hg tip -q
hg verify
